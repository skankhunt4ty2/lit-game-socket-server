require('dotenv').config(); const express = require('express'); const http = require('http'); const { Server } = require('socket.io'); const cors = require('cors'); const app = express(); app.set('trust proxy', true); const corsOptions = { origin: process.env.CORS_ORIGIN || 'https://lit-card-game.vercel.app', methods: ['GET', 'POST', 'OPTIONS'], allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'Accept', 'Origin'], credentials: true, preflightContinue: false, optionsSuccessStatus: 204 }; app.options('*', cors(corsOptions)); app.use(cors(corsOptions)); app.options('/socket.io/*', (req, res) => { res.setHeader('Access-Control-Allow-Origin', process.env.CORS_ORIGIN || 'https://lit-card-game.vercel.app'); res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS'); res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Accept, Origin'); res.setHeader('Access-Control-Allow-Credentials', 'true'); res.setHeader('Access-Control-Max-Age', '86400'); res.setHeader('Vary', 'Origin'); res.status(204).end(); }); const server = http.createServer(app); const io = new Server(server, { cors: { origin: process.env.CORS_ORIGIN || 'https://lit-card-game.vercel.app', methods: ['GET', 'POST', 'OPTIONS'], allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'Accept', 'Origin'], credentials: true, maxAge: 86400 }, transports: ['websocket', 'polling'], pingTimeout: 60000, pingInterval: 25000, connectTimeout: 45000, allowEIO3: true, allowUpgrades: true, path: '/socket.io', cookie: false, maxHttpBufferSize: 1e8, reconnection: true, reconnectionAttempts: 5, reconnectionDelay: 1000, reconnectionDelayMax: 5000, timeout: 20000 });
